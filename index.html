<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Shadow System</title>

  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#070712">

  <style>
    :root{
      --text:#e9e9ff;
      --muted:#a7a7d9;
      --line:rgba(255,255,255,.10);

      --purple:#7c5cff;
      --green:#00ff9a;
      --blue:#4aa3ff;
      --pink:#ff5bd6;

      --shadow: 0 18px 55px rgba(0,0,0,.65);
      --glow: 0 0 18px rgba(124,92,255,.22), 0 0 26px rgba(0,255,154,.10);

      --bgSolid:#070712;
      --bgA: rgba(124,92,255,.18);
      --bgB: rgba(74,163,255,.16);
      --bgC: rgba(0,255,154,.10);
      --bgTop:#05050d;
    }

    *{ box-sizing:border-box; }
    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Arial;
      background:
        radial-gradient(900px 600px at 20% 10%, var(--bgA), transparent 60%),
        radial-gradient(850px 650px at 85% 15%, var(--bgB), transparent 60%),
        radial-gradient(900px 700px at 55% 95%, var(--bgC), transparent 55%),
        linear-gradient(180deg, var(--bgTop), var(--bgSolid));
      color:var(--text);
      min-height:100vh;
      padding:18px;
    }

    .wrap{ width:min(900px, 100%); margin:0 auto; display:grid; gap:12px; }

    .header{
      background: rgba(15,16,32,.75);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:14px;
      display:flex;
      justify-content:space-between;
      gap:12px;
      flex-wrap:wrap;
      position:relative;
      overflow:hidden;
    }
    .header::after{
      content:"";
      position:absolute; inset:-40px;
      background:
        radial-gradient(circle at 30% 30%, rgba(124,92,255,.18), transparent 45%),
        radial-gradient(circle at 80% 25%, rgba(74,163,255,.16), transparent 55%);
      opacity:.9; pointer-events:none;
    }
    .title{ position:relative; z-index:1; }
    .title h1{ margin:0; letter-spacing:1px; text-transform:uppercase; font-size:20px; }
    .sub{ margin-top:6px; color:var(--muted); font-size:12px; line-height:1.35; }

    .badges{ position:relative; z-index:1; display:flex; gap:10px; flex-wrap:wrap; margin-left:auto; }
    .badge{
      background: rgba(20,22,51,.75);
      border:1px solid var(--line);
      border-radius:14px;
      padding:10px 12px;
      min-width:180px;
      box-shadow: var(--glow);
      text-align:right;
    }
    .badge .k{ font-size:11px; color:var(--muted); letter-spacing:1px; text-transform:uppercase; }
    .badge .v{ margin-top:3px; font-size:16px; font-weight:900; }

    .card{
      background: rgba(15,16,32,.78);
      border:1px solid var(--line);
      border-radius:18px;
      box-shadow: var(--shadow);
      padding:14px;
    }
    .card h2{
      margin:0 0 10px 0;
      font-size:13px;
      letter-spacing:1px;
      text-transform:uppercase;
      color:var(--muted);
    }

    .small{ font-size:12px; color: var(--muted); line-height:1.4; }
    .ok{ color:#c8ffd8; }
    .warn{ color:#ffe6a6; }

    .btns{ display:flex; gap:10px; flex-wrap:wrap; }
    .row{ display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:10px; }

    button{
      font: inherit; border:none; cursor:pointer;
      padding:12px 12px; border-radius:14px;
      font-weight:900; letter-spacing:.6px; text-transform:uppercase;
      transition: transform .08s ease, filter .12s ease;
      box-shadow: 0 10px 28px rgba(0,0,0,.35);
    }
    button:hover{ filter: brightness(1.03); }
    button:active{ transform: translateY(1px) scale(.99); }

    .btn-full{ background: linear-gradient(90deg, var(--purple), var(--blue)); color:#070712; }
    .btn-min{ background: linear-gradient(90deg, var(--green), #8effc8); color:#071015; }
    .btn-cond{ background: linear-gradient(90deg, var(--pink), var(--purple)); color:#0a0712; }
    .btn-undo{ background: rgba(255,255,255,.06); border:1px solid var(--line); color:var(--text); box-shadow:none; }
    .btn-reset{ background: rgba(255,59,92,.12); border:1px solid rgba(255,59,92,.35); color: var(--text); box-shadow:none; }

    .grid{
      display:grid;
      grid-template-columns: repeat(4, minmax(140px, 1fr));
      gap:10px;
    }
    @media (max-width: 720px){ .grid{ grid-template-columns: repeat(2, minmax(140px, 1fr)); } }

    label{ font-size:12px; color:var(--muted); }
    input, textarea, select{
      width:100%; padding:10px;
      border-radius:12px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.22);
      color:var(--text);
      outline:none;
    }
    textarea{ resize:vertical; }

    canvas{
      width:100%; height:180px;
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
    }

    .log{
      margin:0; padding:0; list-style:none;
      display:flex; flex-direction:column; gap:8px;
      max-height:260px; overflow:auto;
    }
    .log li{
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      border-radius:14px;
      padding:10px;
      display:flex; justify-content:space-between; gap:10px; align-items:center;
      font-size:13px;
    }
    .tag{
      font-size:11px;
      padding:5px 8px;
      border-radius:999px;
      border:1px solid var(--line);
      white-space:nowrap;
      box-shadow: 0 0 14px rgba(124,92,255,.12);
    }

    .workoutBox{
      white-space: pre-wrap;
      background: rgba(0,0,0,.18);
      border:1px solid var(--line);
      border-radius:14px;
      padding:12px;
      margin:10px 0 12px 0;
    }

    .dayGrid{
      display:grid; gap:10px;
      grid-template-columns: repeat(2, minmax(240px, 1fr));
    }
    @media (max-width: 720px){ .dayGrid{ grid-template-columns: 1fr; } }

    .dayCard{
      border:1px solid var(--line);
      background: rgba(0,0,0,.14);
      border-radius:14px;
      padding:10px;
    }
    .dayTitle{
      font-weight:900; margin-bottom:6px;
      text-transform:uppercase; letter-spacing:.6px;
    }

    .hidden{ display:none !important; }

    .toast{
      position:fixed; left:50%; bottom:16px;
      transform:translateX(-50%);
      background: rgba(20,22,51,.92);
      border:1px solid var(--line);
      padding:10px 12px;
      border-radius:14px;
      box-shadow: var(--glow);
      font-size:13px;
      opacity:0;
      pointer-events:none;
      transition: opacity .18s ease, transform .18s ease;
      z-index: 9998;
    }
    .toast.show{ opacity:1; transform:translateX(-50%) translateY(-4px); }

    /* aura by rank */
    body.rank-S  { filter: drop-shadow(0 0 10px rgba(74,163,255,.12)); }
    body.rank-SS { filter: drop-shadow(0 0 16px rgba(124,92,255,.16)); }
    body.rank-SSS{ filter: drop-shadow(0 0 22px rgba(0,255,154,.14)); }

    .rankGlow{
      text-shadow:
        0 0 8px rgba(124,92,255,.30),
        0 0 14px rgba(74,163,255,.20),
        0 0 20px rgba(0,255,154,.12);
    }

    .pill{
      display:inline-flex;
      align-items:center;
      gap:6px;
      padding:6px 10px;
      border-radius:999px;
      border:1px solid var(--line);
      background: rgba(0,0,0,.18);
      font-size:11px;
      color: rgba(233,233,255,.90);
    }

    /* Checklist styling */
    .checkWrap{
      border:1px solid var(--line);
      background: rgba(0,0,0,.16);
      border-radius:14px;
      padding:10px;
      margin-top:10px;
    }
    .checkItem{
      display:flex;
      gap:10px;
      align-items:flex-start;
      padding:8px 8px;
      border-radius:12px;
      border:1px solid rgba(255,255,255,.08);
      background: rgba(255,255,255,.02);
    }
    .checkItem.done{
      background: rgba(0,255,154,.06);
      border-color: rgba(0,255,154,.18);
      opacity:.95;
    }
    .checkItem input{ width:auto; margin-top:2px; }
    .checkText{ line-height:1.3; font-size:13px; color: rgba(233,233,255,.92); }
    .checkMeta{
      font-size:11px;
      color: var(--muted);
      margin-top:8px;
      display:flex;
      gap:10px;
      flex-wrap:wrap;
      align-items:center;
    }
  </style>
</head>

<body>
  <div class="wrap">
    <header class="header">
      <div class="title">
        <h1>ðŸ©¸ SHADOW SYSTEM</h1>
        <div class="sub">
          Unlimited days â€¢ Sunday start â€¢ Editable templates + auto-scaling by rank<br>
          Skill Tree unlocks â€¢ Checklist + XP bonus â€¢ Admin restore days
        </div>
      </div>

      <div class="badges">
        <div class="badge">
          <div class="k">Day</div>
          <div class="v"><span id="dayNum">1</span></div>
        </div>
        <div class="badge">
          <div class="k">Streak</div>
          <div class="v"><span id="streak">0</span> ðŸ”¥</div>
        </div>
        <div class="badge">
          <div class="k">Rank</div>
          <div class="v"><span id="rank">E</span> â€¢ <span id="xp">0</span> XP</div>
          <div class="k" style="margin-top:6px"><span id="nextRankLine">Next: D in 1200 XP</span></div>
        </div>
      </div>
    </header>

    <section class="card">
      <h2>Todayâ€™s Workout</h2>

      <div class="row" style="justify-content:space-between;">
        <div class="small" id="todayWorkoutName"></div>
        <div class="pill"><span id="restDaysPill">Rest Days: 2</span></div>
      </div>

      <pre class="workoutBox" id="todayWorkoutText"></pre>

      <div class="checkWrap" id="checkWrap">
        <div style="display:flex; justify-content:space-between; gap:10px; align-items:center; flex-wrap:wrap;">
          <div style="font-weight:900; letter-spacing:.6px; text-transform:uppercase; font-size:12px; color: rgba(233,233,255,.92);">
            Checklist
          </div>
          <div style="display:flex; gap:10px; flex-wrap:wrap;">
            <button class="btn-undo" onclick="markAllChecklist(true)">Mark All</button>
            <button class="btn-undo" onclick="markAllChecklist(false)">Clear</button>
          </div>
        </div>
        <div style="height:10px"></div>
        <div id="todayChecklist" style="display:grid; gap:8px;"></div>

        <div class="checkMeta">
          <span id="checkProgress">0 / 0 done</span>
          <span id="checkBonusLine" class="small">Bonus: Complete 80%+ for +10 XP â€¢ 100% for +20 XP</span>
          <button class="btn-undo" onclick="claimChecklistBonus()">Claim Bonus</button>
        </div>
      </div>

      <div class="small" id="todayStatus">Not logged today.</div>

      <div class="btns">
        <button class="btn-min"  onclick="logWorkout('MINIMUM')">Ritual</button>
        <button class="btn-full" onclick="logWorkout('FULL')">Ascension</button>
        <button class="btn-cond" onclick="logWorkout('CONDITIONING')">Boss Fight</button>
      </div>

      <div class="row">
        <button class="btn-undo" onclick="undoToday()">Undo Today</button>
        <button class="btn-undo" onclick="togglePanel('customPanel')">Customize Workouts</button>
        <button class="btn-undo" onclick="togglePanel('settingsPanel')">Settings</button>
        <button class="btn-reset" onclick="resetAll()">Reset</button>
      </div>

      <div class="small" style="margin-top:8px">
        Placeholders: <b>{PUSH}</b>, <b>{SQUAT}</b>, <b>{SETS}</b>, <b>{PLANK}</b> â€¢ Skills: <b>{PUSH_VAR}</b>, <b>{ROW_VAR}</b>, <b>{SQUAT_VAR}</b>, <b>{CORE_VAR}</b>.
      </div>
    </section>

    <section class="card">
      <h2>Stats (Today)</h2>
      <div class="grid">
        <div><label>Max Push-ups</label><input id="inPush" type="number" min="0" placeholder="0"></div>
        <div><label>Max Squats</label><input id="inSquat" type="number" min="0" placeholder="?"></div>
        <div><label>Max Rows</label><input id="inRow" type="number" min="0" placeholder="?"></div>
        <div><label>Bodyweight (lb)</label><input id="inWeight" type="number" min="0" step="0.1" placeholder="220"></div>
      </div>
      <div class="row">
        <button class="btn-undo" onclick="saveStatsOnly()">Save Stats</button>
        <div class="small">Stats save even without a workout log.</div>
      </div>
    </section>

    <section class="card">
      <h2>Graphs</h2>
      <div class="small">Strength = Push + Squat + Row (last 30)</div>
      <canvas id="strengthChart" width="900" height="360"></canvas>
      <div style="height:10px"></div>
      <div class="small">Bodyweight (lb) (last 30)</div>
      <canvas id="weightChart" width="900" height="360"></canvas>
    </section>

    <section class="card">
      <h2>System</h2>
      <div class="small" id="dailyQuote">...</div>

      <div style="height:12px"></div>
      <div class="small">90-day Arc</div>

      <div style="display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:8px;">
        <div style="flex:1; min-width:240px; border:1px solid rgba(255,255,255,.10); border-radius:14px; background: rgba(0,0,0,.18); padding:10px;">
          <div style="display:flex; justify-content:space-between; gap:10px; font-size:12px; color:rgba(167,167,217,.95);">
            <span id="arcLabel">Arc 1</span>
            <span id="arcDayLabel">Day 1 / 90</span>
          </div>
          <div style="height:10px"></div>
          <div style="height:10px; border-radius:999px; background: rgba(255,255,255,.08); overflow:hidden;">
            <div id="arcBar" style="height:10px; width:0%; background: linear-gradient(90deg, rgba(124,92,255,.95), rgba(74,163,255,.85));"></div>
          </div>
        </div>

        <button class="btn-undo" onclick="startNewArc()">Start New Arc</button>
      </div>

      <div class="small" style="margin-top:8px;">
        Swimming on rest days = active recovery (easy/moderate).
      </div>
    </section>

    <section class="card">
      <h2>Skill Tree</h2>
      <div class="small">Unlocks automatically as your Rank increases.</div>
      <div style="height:10px"></div>
      <div id="skillTree" style="display:grid; gap:10px; grid-template-columns: repeat(2, minmax(240px, 1fr));"></div>
    </section>

    <section class="card">
      <h2>Mission Log</h2>
      <ul class="log" id="log"></ul>
    </section>

    <section class="card">
      <h2>Admin / Fix</h2>
      <div class="small">Missed a day? Add it back here to restore XP + streak + charts.</div>

      <div class="grid" style="margin-top:10px;">
        <div>
          <label>Date to add</label>
          <input id="fixDate" type="date">
        </div>
        <div>
          <label>Type</label>
          <select id="fixType">
            <option value="MINIMUM">Ritual (+40)</option>
            <option value="FULL">Ascension (+100)</option>
            <option value="CONDITIONING">Boss Fight (+120)</option>
          </select>
        </div>
        <div>
          <label>Optional note</label>
          <input id="fixNote" type="text" placeholder="ex: swim recovery, travel day">
        </div>
        <div style="display:flex; align-items:flex-end;">
          <button class="btn-full" style="width:100%;" onclick="addMissedDay()">Add Day</button>
        </div>
      </div>

      <div class="row">
        <button class="btn-undo" onclick="recalcXPFromLogs()">Recalculate XP from Logs</button>
        <div class="small">If XP looks wrong, this rebuilds XP from your logs.</div>
      </div>
    </section>

    <section class="card hidden" id="settingsPanel">
      <h2>Settings</h2>
      <div class="grid">
        <div>
          <label>Theme / Background</label>
          <select id="themeSelect"></select>
        </div>
        <div>
          <label>Rank Difficulty</label>
          <select id="difficultySelect">
            <option value="hard">Hard (recommended)</option>
            <option value="normal">Normal</option>
          </select>
        </div>
        <div style="grid-column: 1 / -1;">
          <label>Rest day rule</label>
          <div class="small">Any day containing <b>REST</b> or <b>RECOVERY</b> counts as rest.</div>
        </div>
      </div>

      <div class="row">
        <button class="btn-full" onclick="saveSettings()">Save Settings</button>
        <button class="btn-undo" onclick="togglePanel('settingsPanel')">Close</button>
      </div>
    </section>

    <section class="card hidden" id="customPanel">
      <h2>Customize Your Week (Sunday Start)</h2>
      <div class="small">Edit templates. Use placeholders like {PUSH} or {PUSH_VAR}.</div>

      <div class="dayGrid" style="margin-top:10px">
        <div class="dayCard"><div class="dayTitle">Sunday</div><textarea id="w0" rows="9"></textarea></div>
        <div class="dayCard"><div class="dayTitle">Monday</div><textarea id="w1" rows="9"></textarea></div>
        <div class="dayCard"><div class="dayTitle">Tuesday</div><textarea id="w2" rows="9"></textarea></div>
        <div class="dayCard"><div class="dayTitle">Wednesday</div><textarea id="w3" rows="9"></textarea></div>
        <div class="dayCard"><div class="dayTitle">Thursday</div><textarea id="w4" rows="9"></textarea></div>
        <div class="dayCard"><div class="dayTitle">Friday</div><textarea id="w5" rows="9"></textarea></div>
        <div class="dayCard"><div class="dayTitle">Saturday</div><textarea id="w6" rows="9"></textarea></div>
      </div>

      <div class="row">
        <button class="btn-full" onclick="saveWorkouts()">Save Workouts</button>
        <button class="btn-undo" onclick="restoreWorkoutDefaults()">Restore Defaults</button>
      </div>
    </section>
  </div>

  <div class="toast" id="toast">Saved.</div>

  <div class="hidden" id="systemOverlay" style="
    position:fixed; inset:0; z-index:9999;
    display:flex; align-items:center; justify-content:center;
    background: radial-gradient(circle at 50% 40%, rgba(124,92,255,.20), rgba(0,0,0,.85) 55%, rgba(0,0,0,.96));
    backdrop-filter: blur(2px);
  ">
    <div style="
      width:min(760px,92vw);
      border:1px solid rgba(255,255,255,.14);
      background: rgba(10,10,20,.75);
      border-radius:18px;
      padding:18px;
      box-shadow: 0 0 22px rgba(124,92,255,.25), 0 0 38px rgba(0,255,154,.10);
      position:relative;
      overflow:hidden;
    ">
      <div style="font-weight:900; letter-spacing:2px; text-transform:uppercase; color:rgba(233,233,255,.95); position:relative; z-index:2;">SYSTEM</div>
      <div id="systemTitle" style="margin-top:8px; font-size:22px; font-weight:900; letter-spacing:1px; position:relative; z-index:2;">Rank Up</div>
      <div id="systemText" style="margin-top:10px; color:rgba(233,233,255,.85); line-height:1.5; white-space:pre-wrap; position:relative; z-index:2;">You have grown stronger.</div>
      <div style="margin-top:14px; display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; position:relative; z-index:2;">
        <button class="btn-undo" onclick="hideSystem()">Continue</button>
      </div>
      <div style="
        position:absolute; inset:-80px; z-index:1;
        background:
          radial-gradient(circle at 30% 30%, rgba(124,92,255,.22), transparent 55%),
          radial-gradient(circle at 80% 25%, rgba(74,163,255,.18), transparent 60%),
          radial-gradient(circle at 55% 80%, rgba(0,255,154,.10), transparent 55%);
        opacity:.85; pointer-events:none; transform: rotate(-6deg);
      "></div>
    </div>
  </div>

<script>
/* ===== Storage keys ===== */
const KEY_STATE = "shadow_all_state_v1";
const KEY_WORK  = "shadow_all_workouts_v1";
const KEY_SET   = "shadow_all_settings_v1";

/* ===== XP ===== */
const XP = { FULL: 100, MINIMUM: 40, CONDITIONING: 120 };

/* ===== Ranks ===== */
const RANKS_NORMAL = [
  { name: "E", minXP: 0 }, { name: "D", minXP: 500 }, { name: "C", minXP: 1500 },
  { name: "B", minXP: 3000 }, { name: "A", minXP: 6000 }, { name: "S", minXP: 10000 },
  { name: "SS", minXP: 15000 }, { name: "SSS", minXP: 22000 }
];
const RANKS_HARD = [
  { name: "E", minXP: 0 }, { name: "D", minXP: 1200 }, { name: "C", minXP: 3500 },
  { name: "B", minXP: 7500 }, { name: "A", minXP: 14000 }, { name: "S", minXP: 24000 },
  { name: "SS", minXP: 38000 }, { name: "SSS", minXP: 55000 }
];
function rankOrder(){ return ["E","D","C","B","A","S","SS","SSS"]; }
function rankIndex(name){ return Math.max(0, rankOrder().indexOf(name)); }

/* ===== Themes ===== */
const THEMES = {
  "Shadow Default": { bgSolid:"#070712", bgTop:"#05050d", bgA:"rgba(124,92,255,.18)", bgB:"rgba(74,163,255,.16)", bgC:"rgba(0,255,154,.10)" },
  "Abyss Blue":     { bgSolid:"#040a14", bgTop:"#03070f", bgA:"rgba(74,163,255,.20)", bgB:"rgba(124,92,255,.10)", bgC:"rgba(0,255,154,.06)" },
  "Monarch Purple": { bgSolid:"#070312", bgTop:"#04020a", bgA:"rgba(124,92,255,.24)", bgB:"rgba(255,91,214,.12)", bgC:"rgba(74,163,255,.08)" },
  "Red Eclipse":    { bgSolid:"#12020a", bgTop:"#070106", bgA:"rgba(255,91,214,.10)", bgB:"rgba(255,80,80,.12)", bgC:"rgba(124,92,255,.10)" }
};

/* ===== Arc + Quotes ===== */
const ARC_LEN = 90;
const QUOTES = [
  "System: No zero days. Even a ritual counts.",
  "System: Weakness is temporary. Discipline is permanent.",
  "System: One more rep. One more breath.",
  "System: You donâ€™t need motivation. You need a command.",
  "System: Todayâ€™s mission is simpleâ€”be stronger than yesterday.",
  "System: Pain is data. Learn from it.",
  "System: The hunter who shows up wins.",
  "System: Ascension is built on rituals.",
  "System: A boss fight reveals who you are."
];

/* ===== Skills ===== */
const SKILLS = {
  PUSH: [
    { at: 0, name: "Incline Push-ups" },
    { at: 2, name: "Knee Push-ups" },
    { at: 3, name: "Standard Push-ups" },
    { at: 4, name: "Decline Push-ups" },
    { at: 5, name: "Diamond Push-ups" },
    { at: 6, name: "Archer Push-ups" },
    { at: 7, name: "One-arm Progression" }
  ],
  ROW: [
    { at: 0, name: "Backpack Rows" },
    { at: 2, name: "Table Rows / Door Rows" },
    { at: 4, name: "Slow Tempo Rows" },
    { at: 6, name: "Isometric Row Holds" }
  ],
  SQUAT: [
    { at: 0, name: "Bodyweight Squats" },
    { at: 2, name: "Pause Squats (2 sec)" },
    { at: 3, name: "Bulgarian Split Squats" },
    { at: 5, name: "Jump Squats (controlled)" },
    { at: 6, name: "Pistol Progression" }
  ],
  CORE: [
    { at: 0, name: "Plank" },
    { at: 2, name: "Hollow Hold" },
    { at: 4, name: "Hanging Knee Raises" },
    { at: 6, name: "Toes-to-Bar Progression" }
  ]
};
function unlockedList(rankName, groupKey){
  const idx = rankIndex(rankName);
  return SKILLS[groupKey].filter(s => s.at <= idx);
}
function currentSkill(rankName, groupKey){
  const list = unlockedList(rankName, groupKey);
  return list[list.length - 1]?.name || "Unknown";
}

/* ===== Default workouts ===== */
const DEFAULT_WORKOUTS = [
`SUNDAY â€” PUSH (SYSTEM)
â€¢ {PUSH_VAR} {PUSH} reps Ã— {SETS} sets
â€¢ Pike Push-ups {PUSH} reps Ã— {SETS_MINUS1} sets
â€¢ Chair Dips {PUSH} reps Ã— {SETS_MINUS1} sets
â€¢ {CORE_VAR} {PLANK} sec Ã— 2`,
`MONDAY â€” PULL (SYSTEM)
â€¢ {ROW_VAR} {ROW} reps Ã— {SETS} sets
â€¢ Pull Negatives {PULL_NEG} reps Ã— {SETS_MINUS1} sets
â€¢ Dead Hang {HANG} sec Ã— 2
â€¢ {CORE_VAR} {PLANK} sec Ã— 1`,
`TUESDAY â€” LEGS (SYSTEM)
â€¢ {SQUAT_VAR} {SQUAT} reps Ã— {SETS} sets
â€¢ Split Squats {SQUAT_MINUS4} reps/side Ã— {SETS_MINUS1} sets
â€¢ Hinge (RDL) {HINGE} reps Ã— {SETS_MINUS1} sets
â€¢ Calf Raises {SQUAT} reps Ã— 2`,
`WEDNESDAY â€” RECOVERY (REST)
â€¢ Walk 20â€“30 min OR Swim 20â€“45 min (easy/moderate)
â€¢ Stretch 10 min
â€¢ Mobility 5 min`,
`THURSDAY â€” FULL BODY (SYSTEM)
(Repeat {ROUNDS} rounds)
â€¢ {PUSH_VAR} {PUSH} reps
â€¢ {ROW_VAR} {ROW} reps
â€¢ {SQUAT_VAR} {SQUAT} reps
â€¢ {CORE_VAR} {PLANK} sec`,
`FRIDAY â€” WEAK POINTS (SYSTEM)
â€¢ Push practice: {PUSH_VAR} {PUSH} reps Ã— {SETS_MINUS1} sets
â€¢ Pull practice: {ROW_VAR} {ROW} reps Ã— {SETS_MINUS1} sets
â€¢ Core: {CORE_VAR} {PLANK} sec Ã— 2
â€¢ Mobility 10 min`,
`SATURDAY â€” RECOVERY (REST)
â€¢ Swim 20â€“45 min (easy/moderate) OR Walk 30 min
â€¢ Stretch 10 min`
];

/* ===== Load settings + state ===== */
const settings = load(KEY_SET) ?? { themeName: "Shadow Default", difficulty: "hard" };
function currentRanks(){ return (settings.difficulty === "normal") ? RANKS_NORMAL : RANKS_HARD; }

const state = load(KEY_STATE) ?? { startISO: isoDate(new Date()), xp: 0, logs: [], checks: {} };
if(!state.checks) state.checks = {};
let workouts = load(KEY_WORK) ?? [...DEFAULT_WORKOUTS];

/* ===== UI ===== */
const UI = {
  dayNum: document.getElementById("dayNum"),
  xp: document.getElementById("xp"),
  rank: document.getElementById("rank"),
  nextRankLine: document.getElementById("nextRankLine"),
  streak: document.getElementById("streak"),
  todayStatus: document.getElementById("todayStatus"),
  log: document.getElementById("log"),
  todayWorkoutName: document.getElementById("todayWorkoutName"),
  todayWorkoutText: document.getElementById("todayWorkoutText"),
  restDaysPill: document.getElementById("restDaysPill"),
  inPush: document.getElementById("inPush"),
  inSquat: document.getElementById("inSquat"),
  inRow: document.getElementById("inRow"),
  inWeight: document.getElementById("inWeight"),
  toast: document.getElementById("toast"),
  themeSelect: document.getElementById("themeSelect"),
  difficultySelect: document.getElementById("difficultySelect"),

  todayChecklist: document.getElementById("todayChecklist"),
  checkProgress: document.getElementById("checkProgress"),
  checkBonusLine: document.getElementById("checkBonusLine"),

  fixDate: document.getElementById("fixDate"),
  fixType: document.getElementById("fixType"),
  fixNote: document.getElementById("fixNote"),
};

/* ===== Init ===== */
populateSettingsUI();
applyTheme(settings.themeName);
hydrateWorkoutEditor();
render();
registerSW();

/* ===== Helpers ===== */
function isoDate(d){
  const y = d.getFullYear();
  const m = String(d.getMonth()+1).padStart(2,"0");
  const day = String(d.getDate()).padStart(2,"0");
  return `${y}-${m}-${day}`;
}
function parseISO(iso){ return new Date(iso + "T00:00:00"); }
function daysBetween(aISO, bISO){
  return Math.round((parseISO(bISO) - parseISO(aISO)) / (1000*60*60*24));
}
function dayNumberToday(){
  const diff = daysBetween(state.startISO, isoDate(new Date()));
  return Math.max(1, diff + 1);
}
function todayISO(){ return isoDate(new Date()); }
function hasTodayLog(){ return state.logs.some(l => l.iso === todayISO()); }
function todayLog(){ return state.logs.find(l => l.iso === todayISO()) ?? null; }
function computeStreak(){
  if(state.logs.length === 0) return 0;
  const days = [...new Set(state.logs.map(l => l.iso))].sort();
  let s = 1;
  for(let i = days.length - 1; i > 0; i--){
    if(daysBetween(days[i-1], days[i]) === 1) s++;
    else break;
  }
  return s;
}
function numOrNull(v){
  if(v === "" || v == null) return null;
  const n = Number(v);
  return Number.isFinite(n) ? n : null;
}
function readInputs(){
  return {
    push: numOrNull(UI.inPush.value),
    squat: numOrNull(UI.inSquat.value),
    row: numOrNull(UI.inRow.value),
    weight: numOrNull(UI.inWeight.value)
  };
}

/* ===== Rank logic ===== */
function getRankInfo(xp){
  const R = currentRanks();
  let current = R[0];
  for(const r of R){
    if(xp >= r.minXP) current = r;
    else break;
  }
  const idx = R.findIndex(r => r.name === current.name);
  const next = (idx >= 0 && idx < R.length - 1) ? R[idx + 1] : null;
  return { current, next };
}

/* ===== Scaling ===== */
function scalingForRank(rankName){
  const i = rankIndex(rankName);
  const clamp = (v, min, max) => Math.max(min, Math.min(max, v));

  const sets = clamp(3 + Math.floor(i/2), 3, 6);
  const rounds = clamp(3 + Math.floor(i/3), 3, 6);

  const push = clamp(6 + i*2, 6, 25);
  const row  = clamp(8 + i*2, 8, 28);
  const squat= clamp(12 + i*3, 12, 40);
  const hinge= clamp(10 + i*2, 10, 28);

  const plank = clamp(25 + i*10, 25, 120);
  const hang  = clamp(20 + i*8, 20, 90);
  const pullNeg = clamp(3 + Math.floor(i/1.5), 3, 10);

  return {
    SETS: sets,
    SETS_MINUS1: Math.max(2, sets-1),
    ROUNDS: rounds,
    PUSH: push,
    ROW: row,
    SQUAT: squat,
    SQUAT_MINUS4: Math.max(6, squat-4),
    HINGE: hinge,
    PLANK: plank,
    HANG: hang,
    PULL_NEG: pullNeg,
    PUSH_VAR: currentSkill(rankName, "PUSH"),
    ROW_VAR: currentSkill(rankName, "ROW"),
    SQUAT_VAR: currentSkill(rankName, "SQUAT"),
    CORE_VAR: currentSkill(rankName, "CORE")
  };
}
function applyPlaceholders(template, rankName){
  const s = scalingForRank(rankName);
  return template.replace(/\{([A-Z_]+)\}/g, (m, key) => (key in s ? String(s[key]) : m));
}

/* ===== Checklist ===== */
function extractChecklistItems(renderedText){
  const lines = (renderedText || "").split("\n").map(l => l.trim()).filter(Boolean);
  const items = [];
  for(const l of lines){
    if(l.startsWith("â€¢")) items.push(l.replace(/^â€¢\s*/, ""));
    else if(l.startsWith("-")) items.push(l.replace(/^-+\s*/, ""));
    else if(l.startsWith("*")) items.push(l.replace(/^\*\s*/, ""));
  }
  return items;
}
function ensureChecklistForDate(iso, items){
  const existing = state.checks[iso];
  const same = existing && Array.isArray(existing.items) && Array.isArray(existing.done) &&
               existing.items.join("||") === items.join("||");
  if(!same){
    state.checks[iso] = { items, done: items.map(()=>false), bonusClaimed: false };
    save(KEY_STATE, state);
  }
}
function checklistStatsForDate(iso){
  const data = state.checks?.[iso];
  if(!data || !Array.isArray(data.items) || !Array.isArray(data.done)) return null;
  const total = data.items.length;
  const done = data.done.filter(Boolean).length;
  const pct = total > 0 ? (done/total) : 0;
  return { total, done, pct, data };
}
function checklistBonusForPct(pct){
  if(pct >= 1) return 20;
  if(pct >= 0.80) return 10;
  return 0;
}

function renderChecklistForToday(renderedText){
  const iso = todayISO();
  const items = extractChecklistItems(renderedText);

  if(items.length === 0){
    UI.todayChecklist.innerHTML = `<div class="small">No checklist items found. Use bullet lines starting with â€¢ in your workout template.</div>`;
    UI.checkProgress.textContent = `0 / 0 done`;
    if(UI.checkBonusLine) UI.checkBonusLine.textContent = `Bonus: Complete 80%+ for +10 XP â€¢ 100% for +20 XP`;
    return;
  }

  ensureChecklistForDate(iso, items);
  const data = state.checks[iso];

  UI.todayChecklist.innerHTML = "";
  items.forEach((text, idx) => {
    const row = document.createElement("label");
    row.className = "checkItem" + (data.done[idx] ? " done" : "");
    row.style.cursor = "pointer";

    const cb = document.createElement("input");
    cb.type = "checkbox";
    cb.checked = !!data.done[idx];
    cb.addEventListener("change", () => {
      data.done[idx] = cb.checked;
      state.checks[iso] = data;
      save(KEY_STATE, state);
      renderChecklistForToday(renderedText);
    });

    const span = document.createElement("div");
    span.className = "checkText";
    span.textContent = text;

    row.appendChild(cb);
    row.appendChild(span);
    UI.todayChecklist.appendChild(row);
  });

  const doneCount = data.done.filter(Boolean).length;
  UI.checkProgress.textContent = `${doneCount} / ${items.length} done`;

  const pct = items.length ? (doneCount / items.length) : 0;
  const bonus = checklistBonusForPct(pct);
  const claimed = !!state.checks[iso]?.bonusClaimed;

  if(UI.checkBonusLine){
    if(claimed){
      UI.checkBonusLine.textContent = `Bonus claimed âœ… (+${bonus} XP was awarded)`;
    } else if(bonus > 0){
      UI.checkBonusLine.textContent = `Bonus ready: +${bonus} XP (press Claim Bonus)`;
    } else {
      UI.checkBonusLine.textContent = `Bonus: Complete 80%+ for +10 XP â€¢ 100% for +20 XP`;
    }
  }
}

window.markAllChecklist = function(flag){
  const iso = todayISO();
  const data = state.checks[iso];
  if(!data || !Array.isArray(data.done)) return toast("No checklist yet.");
  data.done = data.done.map(()=>!!flag);
  state.checks[iso] = data;
  save(KEY_STATE, state);
  setTodayWorkout();
  toast(flag ? "All marked." : "Cleared.");
};

window.claimChecklistBonus = function(){
  const iso = todayISO();
  const stats = checklistStatsForDate(iso);
  if(!stats) return toast("No checklist found for today.");

  const bonus = checklistBonusForPct(stats.pct);
  if(bonus <= 0) return toast("Not enough completed for a bonus yet.");
  if(state.checks[iso].bonusClaimed) return toast("Bonus already claimed today.");

  state.xp += bonus;
  state.checks[iso].bonusClaimed = true;

  state.logs.push({
    iso,
    kind: "CHECKLIST BONUS",
    xp: bonus,
    note: `${Math.round(stats.pct * 100)}% completed`
  });
  state.logs.sort((a,b) => a.iso.localeCompare(b.iso));

  save(KEY_STATE, state);
  toast(`Bonus claimed (+${bonus} XP)!`);
  render();
};

/* ===== Today workout ===== */
function todayIndexSundayStart(){ return new Date().getDay(); }
function setTodayWorkout(){
  const idx = todayIndexSundayStart();
  const names = ["Sunday","Monday","Tuesday","Wednesday","Thursday","Friday","Saturday"];
  UI.todayWorkoutName.textContent = `Today is ${names[idx]} â€” highlighted mission`;

  const rankName = getRankInfo(state.xp).current.name;
  const template = workouts[idx] || "No workout set for today.";
  const rendered = applyPlaceholders(template, rankName);

  UI.todayWorkoutText.textContent = rendered;
  renderChecklistForToday(rendered);
}

/* ===== Rest days ===== */
function isRestDayText(t){
  const u = (t || "").toUpperCase();
  return u.includes("REST") || u.includes("RECOVERY");
}
function countRestDays(){
  let n = 0;
  for(const w of workouts) if(isRestDayText(w)) n++;
  return n;
}

/* ===== Skill Tree render ===== */
function renderSkillTree(){
  const host = document.getElementById("skillTree");
  if(!host) return;

  const rankName = getRankInfo(state.xp).current.name;
  const idx = rankIndex(rankName);

  const groups = [
    { key:"PUSH", title:"Push Skills" },
    { key:"ROW", title:"Pull Skills" },
    { key:"SQUAT", title:"Leg Skills" },
    { key:"CORE", title:"Core Skills" }
  ];

  host.innerHTML = "";
  for(const g of groups){
    const box = document.createElement("div");
    box.style.border = "1px solid rgba(255,255,255,.10)";
    box.style.borderRadius = "14px";
    box.style.background = "rgba(0,0,0,.18)";
    box.style.padding = "10px";

    const title = document.createElement("div");
    title.style.fontWeight = "900";
    title.style.letterSpacing = ".6px";
    title.style.textTransform = "uppercase";
    title.style.marginBottom = "8px";
    title.textContent = g.title;

    const current = document.createElement("div");
    current.className = "small";
    current.innerHTML = `Current: <b>${currentSkill(rankName, g.key)}</b>`;

    const list = document.createElement("div");
    list.style.marginTop = "10px";
    list.style.display = "grid";
    list.style.gap = "6px";

    for(const s of SKILLS[g.key]){
      const item = document.createElement("div");
      const unlocked = s.at <= idx;

      item.style.display = "flex";
      item.style.justifyContent = "space-between";
      item.style.alignItems = "center";
      item.style.padding = "8px 10px";
      item.style.borderRadius = "12px";
      item.style.border = "1px solid rgba(255,255,255,.10)";
      item.style.background = unlocked ? "rgba(0,255,154,.06)" : "rgba(255,255,255,.03)";
      item.style.color = unlocked ? "rgba(233,233,255,.95)" : "rgba(167,167,217,.70)";

      const left = document.createElement("span");
      left.textContent = s.name;

      const right = document.createElement("span");
      right.style.fontSize = "11px";
      right.style.padding = "4px 8px";
      right.style.borderRadius = "999px";
      right.style.border = "1px solid rgba(255,255,255,.10)";
      right.textContent = unlocked ? "UNLOCKED" : `LOCKED (Rank ${rankOrder()[s.at]})`;

      item.appendChild(left);
      item.appendChild(right);
      list.appendChild(item);
    }

    box.appendChild(title);
    box.appendChild(current);
    box.appendChild(list);
    host.appendChild(box);
  }
}

/* ===== System + Arc + Quote ===== */
function setDailyQuote(){
  const t = todayISO();
  let seed = 0;
  for(const ch of t) seed = (seed * 31 + ch.charCodeAt(0)) >>> 0;
  document.getElementById("dailyQuote").textContent = QUOTES[seed % QUOTES.length];
}
function arcInfo(){
  const day = dayNumberToday();
  const arc = Math.floor((day - 1) / ARC_LEN) + 1;
  const arcDay = ((day - 1) % ARC_LEN) + 1;
  return { arc, arcDay, day };
}
function renderArc(){
  const { arc, arcDay } = arcInfo();
  document.getElementById("arcLabel").textContent = `Arc ${arc}`;
  document.getElementById("arcDayLabel").textContent = `Day ${arcDay} / ${ARC_LEN}`;
  document.getElementById("arcBar").style.width = `${Math.round((arcDay / ARC_LEN) * 100)}%`;
}
window.startNewArc = function(){
  state.startISO = todayISO();
  save(KEY_STATE, state);
  toast("New Arc started.");
  render();
};

/* ===== Overlay + sound ===== */
window.hideSystem = function(){
  document.getElementById("systemOverlay").classList.add("hidden");
};
function showSystem(title, text){
  document.getElementById("systemTitle").textContent = title;
  document.getElementById("systemText").textContent = text;
  document.getElementById("systemOverlay").classList.remove("hidden");
  playRankUpSound();
}
function playRankUpSound(){
  try{
    const AudioCtx = window.AudioContext || window.webkitAudioContext;
    if(!AudioCtx) return;
    const ctx = new AudioCtx();
    const o = ctx.createOscillator();
    const g = ctx.createGain();
    o.type = "sine";
    o.frequency.setValueAtTime(180, ctx.currentTime);
    o.frequency.exponentialRampToValueAtTime(420, ctx.currentTime + 0.12);
    o.frequency.exponentialRampToValueAtTime(240, ctx.currentTime + 0.30);
    g.gain.setValueAtTime(0.0001, ctx.currentTime);
    g.gain.exponentialRampToValueAtTime(0.12, ctx.currentTime + 0.03);
    g.gain.exponentialRampToValueAtTime(0.0001, ctx.currentTime + 0.35);
    o.connect(g); g.connect(ctx.destination);
    o.start(); o.stop(ctx.currentTime + 0.36);
    o.onended = () => ctx.close();
  } catch(e){}
}

/* ===== Actions ===== */
window.logWorkout = function(kind){
  const before = getRankInfo(state.xp).current.name;
  const iso = todayISO();
  if(state.logs.some(l => l.iso === iso)) return toast("Already logged today. Undo if needed.");

  const xpGain = XP[kind] ?? 0;
  const stats = readInputs();
  state.logs.push({ iso, kind, xp: xpGain, ...stats });
  state.xp += xpGain;

  save(KEY_STATE, state);
  toast(`Mission logged (+${xpGain} XP).`);
  render();

  const after = getRankInfo(state.xp).current.name;
  if(after !== before){
    showSystem("Rank Up", `You have awakened greater power.\nRank: ${before} â†’ ${after}`);
  }
};

window.saveStatsOnly = function(){
  const iso = todayISO();
  const stats = readInputs();
  const ex = state.logs.find(l => l.iso === iso);
  if(ex){
    Object.assign(ex, stats);
    save(KEY_STATE, state);
    toast("Updated stats.");
    return render();
  }
  state.logs.push({ iso, kind: "STATS ONLY", xp: 0, ...stats });
  save(KEY_STATE, state);
  toast("Stats saved.");
  render();
};

window.undoToday = function(){
  const iso = todayISO();
  const idx = state.logs.findIndex(l => l.iso === iso);
  if(idx === -1) return toast("Nothing logged today.");
  const removed = state.logs.splice(idx, 1)[0];
  state.xp -= (removed.xp || 0);
  if(state.xp < 0) state.xp = 0;
  save(KEY_STATE, state);
  toast("Undid today.");
  render();
};

window.togglePanel = function(id){
  document.getElementById(id)?.classList.toggle("hidden");
};

window.resetAll = function(){
  if(!confirm("Reset EVERYTHING? This clears logs + workouts + settings + checklist.")) return;
  localStorage.removeItem(KEY_STATE);
  localStorage.removeItem(KEY_WORK);
  localStorage.removeItem(KEY_SET);
  location.reload();
};

/* ===== Workouts ===== */
function hydrateWorkoutEditor(){
  for(let i=0;i<7;i++){
    const ta = document.getElementById("w"+i);
    if(ta) ta.value = workouts[i] || "";
  }
}
window.saveWorkouts = function(){
  workouts = Array.from({length:7}, (_,i) => (document.getElementById("w"+i).value || "").trim());
  save(KEY_WORK, workouts);
  toast("Workouts saved.");
  render();
};
window.restoreWorkoutDefaults = function(){
  workouts = [...DEFAULT_WORKOUTS];
  save(KEY_WORK, workouts);
  hydrateWorkoutEditor();
  toast("Defaults restored.");
  render();
};

/* ===== Settings ===== */
function populateSettingsUI(){
  UI.themeSelect.innerHTML = "";
  Object.keys(THEMES).forEach(name => {
    const opt = document.createElement("option");
    opt.value = name;
    opt.textContent = name;
    UI.themeSelect.appendChild(opt);
  });
  UI.themeSelect.value = settings.themeName || "Shadow Default";
  UI.difficultySelect.value = settings.difficulty || "hard";
}
window.saveSettings = function(){
  settings.themeName = UI.themeSelect.value || "Shadow Default";
  settings.difficulty = UI.difficultySelect.value || "hard";
  save(KEY_SET, settings);
  applyTheme(settings.themeName);
  toast("Settings saved.");
  render();
};
function applyTheme(themeName){
  const t = THEMES[themeName] || THEMES["Shadow Default"];
  document.documentElement.style.setProperty("--bgSolid", t.bgSolid);
  document.documentElement.style.setProperty("--bgTop", t.bgTop);
  document.documentElement.style.setProperty("--bgA", t.bgA);
  document.documentElement.style.setProperty("--bgB", t.bgB);
  document.documentElement.style.setProperty("--bgC", t.bgC);
}

/* ===== Admin / Fix ===== */
window.addMissedDay = function(){
  const d = UI.fixDate?.value;
  const kind = UI.fixType?.value;
  const note = (UI.fixNote?.value || "").trim();
  if(!d) return toast("Pick a date first.");
  if(!kind) return toast("Pick a type first.");
  if(daysBetween(d, todayISO()) < 0) return toast("That date is in the future.");
  if(state.logs.some(l => l.iso === d)) return toast("That date already has a log.");

  const xpGain = XP[kind] ?? 0;
  state.logs.push({ iso: d, kind, xp: xpGain, note });
  state.logs.sort((a,b) => a.iso.localeCompare(b.iso));
  state.xp += xpGain;
  save(KEY_STATE, state);
  toast(`Added ${d} (+${xpGain} XP).`);
  render();
};

window.recalcXPFromLogs = function(){
  let total = 0;
  for(const l of state.logs) total += (l.xp || 0);
  state.xp = Math.max(0, total);
  save(KEY_STATE, state);
  toast("XP recalculated.");
  render();
};

/* ===== Log + Charts ===== */
function pretty(iso){ const [y,m,d] = iso.split("-"); return `${m}/${d}/${y}`; }

function renderLog(){
  UI.log.innerHTML = "";
  const items = [...state.logs].slice(-30).reverse();
  if(items.length === 0){
    const li = document.createElement("li");
    li.textContent = "No logs yet. Day 1 begins now.";
    UI.log.appendChild(li);
    return;
  }

  for(const it of items){
    const li = document.createElement("li");
    const left = document.createElement("span");

    const stats = [];
    if(it.push != null) stats.push(`P:${it.push}`);
    if(it.squat != null) stats.push(`S:${it.squat}`);
    if(it.row != null) stats.push(`R:${it.row}`);
    if(it.weight != null) stats.push(`W:${it.weight}`);

    const noteTxt = it.note ? ` â€¢ ${it.note}` : "";
    left.textContent =
      `${pretty(it.iso)} â€” ${it.kind} ${it.xp ? `(+${it.xp})` : ""}` +
      `${stats.length ? " â€¢ " + stats.join(" ") : ""}` +
      `${noteTxt}`;

    const tag = document.createElement("span");
    tag.className = "tag";
    tag.textContent = it.kind;

    li.appendChild(left);
    li.appendChild(tag);
    UI.log.appendChild(li);
  }
}

function renderCharts(){
  const strengthPoints = state.logs
    .filter(l => (l.push != null) || (l.squat != null) || (l.row != null))
    .slice(-30)
    .map(l => ({ x: l.iso, y: (l.push||0)+(l.squat||0)+(l.row||0) }));

  const weightPoints = state.logs
    .filter(l => l.weight != null)
    .slice(-30)
    .map(l => ({ x: l.iso, y: l.weight }));

  drawLineChart(document.getElementById("strengthChart"), strengthPoints, "Strength");
  drawLineChart(document.getElementById("weightChart"), weightPoints, "Weight (lb)");
}

function drawLineChart(canvas, points, label){
  const ctx = canvas.getContext("2d");
  const w = canvas.width, h = canvas.height;
  ctx.clearRect(0,0,w,h);

  ctx.strokeStyle = "rgba(255,255,255,0.08)";
  ctx.lineWidth = 1;
  for(let i=1;i<6;i++){
    const y = (h*i)/6;
    ctx.beginPath(); ctx.moveTo(40, y); ctx.lineTo(w-12, y); ctx.stroke();
  }

  ctx.strokeStyle = "rgba(255,255,255,0.12)";
  ctx.beginPath(); ctx.moveTo(40, 12); ctx.lineTo(40, h-30); ctx.lineTo(w-12, h-30); ctx.stroke();

  ctx.fillStyle = "rgba(233,233,255,0.9)";
  ctx.font = "bold 16px system-ui";
  ctx.fillText(label, 44, 28);

  if(points.length < 2){
    ctx.fillStyle = "rgba(167,167,217,0.85)";
    ctx.font = "12px system-ui";
    ctx.fillText("Add a few entries to see the line.", 44, 54);
    return;
  }

  const ys = points.map(p => p.y);
  let minY = Math.min(...ys);
  let maxY = Math.max(...ys);
  if(minY === maxY){ minY -= 1; maxY += 1; }

  const plotX0 = 40, plotX1 = w-12;
  const plotY0 = 12, plotY1 = h-30;

  const xAt = i => plotX0 + (i/(points.length-1))*(plotX1-plotX0);
  const yAt = v => {
    const t = (v - minY) / (maxY - minY);
    return plotY1 - t*(plotY1-plotY0);
  };

  ctx.strokeStyle = "rgba(124,92,255,0.9)";
  ctx.lineWidth = 3;
  ctx.beginPath();
  ctx.moveTo(xAt(0), yAt(points[0].y));
  for(let i=1;i<points.length;i++) ctx.lineTo(xAt(i), yAt(points[i].y));
  ctx.stroke();

  ctx.fillStyle = "rgba(0,255,154,0.9)";
  for(let i=0;i<points.length;i++){
    const x = xAt(i), y = yAt(points[i].y);
    ctx.beginPath(); ctx.arc(x,y,4,0,Math.PI*2); ctx.fill();
  }

  ctx.fillStyle = "rgba(167,167,217,0.85)";
  ctx.font = "12px system-ui";
  ctx.fillText(`min: ${minY.toFixed(1)}`, 44, h-10);
  ctx.fillText(`max: ${maxY.toFixed(1)}`, 140, h-10);
}

/* ===== Render ===== */
function render(){
  document.body.classList.remove("rank-S","rank-SS","rank-SSS");

  UI.dayNum.textContent = dayNumberToday();

  const info = getRankInfo(state.xp);
  UI.xp.textContent = state.xp;
  UI.rank.textContent = info.current.name;

  UI.rank.classList.remove("rankGlow");
  if(info.current.name === "S" || info.current.name === "SS" || info.current.name === "SSS"){
    UI.rank.classList.add("rankGlow");
    document.body.classList.add(`rank-${info.current.name}`);
  }

  UI.nextRankLine.textContent = info.next
    ? `Next: ${info.next.name} in ${Math.max(0, info.next.minXP - state.xp)} XP`
    : `MAX RANK: ${info.current.name}`;

  UI.streak.textContent = computeStreak();
  UI.todayStatus.innerHTML = todayLog()
    ? `<span class="ok">Logged today:</span> ${todayLog().kind} (+${todayLog().xp} XP)`
    : `<span class="warn">Not logged today.</span> Even Ritual counts.`;

  UI.restDaysPill.textContent = `Rest Days: ${countRestDays()}`;

  renderLog();
  renderCharts();
  setTodayWorkout();
  setDailyQuote();
  renderArc();
  renderSkillTree();
}

/* ===== Storage ===== */
function load(key){
  const raw = localStorage.getItem(key);
  if(!raw) return null;
  try { return JSON.parse(raw); } catch(e){ return null; }
}
function save(key, val){ localStorage.setItem(key, JSON.stringify(val)); }

/* ===== Toast ===== */
function toast(msg){
  UI.toast.textContent = msg;
  UI.toast.classList.add("show");
  clearTimeout(window.__toastT);
  window.__toastT = setTimeout(() => UI.toast.classList.remove("show"), 1400);
}

/* ===== Service worker ===== */
function registerSW(){
  if(!("serviceWorker" in navigator)) return;
  navigator.serviceWorker.register("./service-worker.js").catch(()=>{});
}
</script>
</body>
</html>
